name: ci
on:
  push:
  pull_request:
jobs:
  backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres
      JWT_SECRET: test-secret
      JWT_REFRESH_SECRET: test-refresh
      SESSION_SECRET: test-session
      NODE_ENV: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install backend deps
        working-directory: backend
        run: npm ci
      - name: Run migrations
        working-directory: backend
        run: npm run db:migrate
      - name: Smoke tests
        working-directory: backend
        run: npm run test:smoke || true
      - name: E2E tests
        working-directory: backend
        run: npm run test:e2e || true
      - name: Deploy to Render
        if: success()
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK_URL" ]; then
            curl -fsSL -X POST "$RENDER_DEPLOY_HOOK_URL" -H "Content-Type: application/json" -d '{}'
          else
            echo "RENDER_DEPLOY_HOOK_URL not set; skipping deploy"
          fi
      - name: Install jq
        if: success()
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
      - name: Verify Render deployment
        if: success()
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "RENDER_API_KEY or RENDER_SERVICE_ID not set; skipping verification"
            exit 0
          fi
          START_TS=$(date +%s)
          CI_SHA=${GITHUB_SHA}
          CI_BRANCH=${GITHUB_REF_NAME}
          CI_COMMIT_MSG=$(git log -1 --pretty=%s || echo "unknown")
          CI_COMMIT_AUTHOR=$(git log -1 --pretty=%an || echo "unknown")
          echo "Verifying Render deploy for service: $RENDER_SERVICE_ID"
          echo "Commit: sha=$CI_SHA branch=$CI_BRANCH author=$CI_COMMIT_AUTHOR subject=$CI_COMMIT_MSG"
          for i in $(seq 1 180); do
            RESP=$(curl -fsSL -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys?limit=1" || true)
            STATUS=$(echo "$RESP" | jq -r '.[0].status // empty')
            DEPLOY_ID=$(echo "$RESP" | jq -r '.[0].id // empty')
            RENDER_COMMIT_ID=$(echo "$RESP" | jq -r '.[0].commitId // empty')
            RENDER_COMMIT_MSG=$(echo "$RESP" | jq -r '.[0].commitMessage // empty')
            echo "Attempt $i: status=$STATUS deployId=$DEPLOY_ID renderCommit=$RENDER_COMMIT_ID"
            if [ "$STATUS" = "live" ] || [ "$STATUS" = "succeeded" ] || [ "$STATUS" = "deployed" ]; then
              END_TS=$(date +%s)
              ELAPSED=$((END_TS-START_TS))
              echo "Render deploy succeeded in ${ELAPSED}s"
              echo "CI commit: $CI_SHA ($CI_COMMIT_MSG) by $CI_COMMIT_AUTHOR on $CI_BRANCH"
              if [ -n "$RENDER_COMMIT_ID" ] || [ -n "$RENDER_COMMIT_MSG" ]; then
                echo "Render commit: $RENDER_COMMIT_ID ($RENDER_COMMIT_MSG)"
              fi
              exit 0
            fi
            if [ "$STATUS" = "failed" ] || [ "$STATUS" = "canceled" ] || [ "$STATUS" = "cancelled" ]; then
              END_TS=$(date +%s)
              ELAPSED=$((END_TS-START_TS))
              echo "Render deploy failed after ${ELAPSED}s"
              echo "$RESP"
              exit 1
            fi
            sleep 10
          done
          END_TS=$(date +%s)
          ELAPSED=$((END_TS-START_TS))
          echo "Timeout waiting for Render deploy after ${ELAPSED}s"
          exit 1
      - name: Check /metrics health
        if: success()
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_EXTERNAL_URL: ${{ secrets.RENDER_EXTERNAL_URL }}
        run: |
          get_url() {
            if [ -n "$RENDER_EXTERNAL_URL" ]; then echo "$RENDER_EXTERNAL_URL"; return; fi
            if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then echo ""; return; fi
            SVC=$(curl -fsSL -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID" || true)
            URL=$(echo "$SVC" | jq -r '.externalUrl // .serviceDetails.externalUrl // .serviceDetails.url // .url // empty')
            echo "$URL"
          }
          URL=$(get_url)
          if [ -z "$URL" ]; then echo "External URL not found; skipping metrics check"; exit 0; fi
          echo "Checking metrics at: ${URL}/metrics"
          for i in $(seq 1 30); do
            RES=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/metrics" || true)
            if [ "$RES" = "200" ]; then echo "Metrics endpoint OK"; break; fi
            sleep 10
          done
          OUT=$(curl -fsSL "${URL}/metrics" || true)
          echo "$OUT" | head -n 10
          echo "$OUT" | grep -E 'http_requests_total|http_request_duration_seconds' >/dev/null && echo "Required metrics present" || (echo "Required metrics missing" && exit 1)
      - name: Trial signup smoke
        if: success()
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_EXTERNAL_URL: ${{ secrets.RENDER_EXTERNAL_URL }}
        run: |
          get_url() {
            if [ -n "$RENDER_EXTERNAL_URL" ]; then echo "$RENDER_EXTERNAL_URL"; return; fi
            if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then echo ""; return; fi
            SVC=$(curl -fsSL -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID" || true)
            URL=$(echo "$SVC" | jq -r '.externalUrl // .serviceDetails.externalUrl // .serviceDetails.url // .url // empty')
            echo "$URL"
          }
          URL=$(get_url)
          if [ -z "$URL" ]; then echo "External URL not found; skipping trial signup"; exit 0; fi
          TS=$(date +%s)
          EMAIL="admin+ci_${TS}@example.edu"
          BODY=$(jq -n --arg sn "مدرسة CI ${TS}" --arg an "مدير CI" --arg ae "$EMAIL" --arg ap "S!ch00lCrm2025#" '{schoolName:$sn, adminName:$an, adminEmail:$ae, adminPassword:$ap}')
          RESP=$(curl -fsSL -X POST "$URL/api/auth/trial-signup" -H "Content-Type: application/json" --data "$BODY" || true)
          TOKEN=$(echo "$RESP" | jq -r '.token // empty')
          REFRESH=$(echo "$RESP" | jq -r '.refreshToken // empty')
          if [ -z "$TOKEN" ] || [ -z "$REFRESH" ]; then echo "Trial signup failed: $RESP"; exit 1; fi
          echo "Trial signup OK for $EMAIL"
          REFR=$(curl -fsSL -X POST "$URL/api/auth/refresh" -H "Content-Type: application/json" --data "$(jq -n --arg rt "$REFRESH" '{refreshToken:$rt}')" || true)
          ACCESS=$(echo "$REFR" | jq -r '.token // empty')
          if [ -z "$ACCESS" ]; then echo "Refresh failed: $REFR"; exit 1; fi
          echo "Refresh token OK (length: ${#ACCESS})"
